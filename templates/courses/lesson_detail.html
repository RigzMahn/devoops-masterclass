{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lesson.title }} - {{ lesson.module.course.title }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Lesson Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-2">
                    <a href="{% url 'course_list' %}" class="hover:text-indigo-600">Courses</a>
                    <span>></span>
                    <a href="{% url 'course_detail' lesson.module.course.pk %}" class="hover:text-indigo-600">{{ lesson.module.course.title }}</a>
                    <span>></span>
                    <span class="text-gray-900">{{ lesson.title }}</span>
                </nav>
                <h1 class="text-3xl font-bold text-gray-900">{{ lesson.title }}</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="px-3 py-1 bg-{{ lesson.lesson_type }}-100 text-{{ lesson.lesson_type }}-800 text-sm font-medium rounded-full capitalize">
                    {{ lesson.lesson_type }}
                </span>
                <span class="text-gray-500">{{ lesson.duration_minutes }} min</span>
            </div>
        </div>

        <!-- Progress and Actions -->
        <div class="flex items-center justify-between pt-4 border-t border-gray-200">
            <div class="flex items-center space-x-4">
                <!-- Completion Toggle -->
                <form method="post" action="{% url 'mark_lesson_complete' lesson.pk %}" class="lesson-completion-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="{% if is_lesson_completed %}incomplete{% else %}complete{% endif %}">
                    <button type="submit" class="flex items-center space-x-2 px-4 py-2 rounded-lg {% if is_lesson_completed %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-700{% endif %} hover:bg-gray-200 transition duration-300">
                        <i class="fas {% if is_lesson_completed %}fa-check-circle{% else %}fa-circle{% endif %}"></i>
                        <span>{% if is_lesson_completed %}Completed{% else %}Mark Complete{% endif %}</span>
                    </button>
                </form>

                <!-- Course Progress -->
                {% if user_progress %}
                <div class="flex items-center space-x-2">
                    <div class="w-32 bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: {{ user_progress.progress_percentage }}%"></div>
                    </div>
                    <span class="text-sm text-gray-600">{{ user_progress.progress_percentage }}%</span>
                </div>
                {% endif %}
            </div>

            <!-- Navigation -->
            <div class="flex space-x-2">
                {% if previous_lesson %}
                <a href="{% url 'lesson_detail' previous_lesson.pk %}" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">
                    <i class="fas fa-arrow-left"></i>
                    <span>Previous</span>
                </a>
                {% endif %}

                {% if next_lesson %}
                <a href="{% url 'lesson_detail' next_lesson.pk %}" class="flex items-center space-x-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-300">
                    <span>Next</span>
                    <i class="fas fa-arrow-right"></i>
                </a>
                {% else %}
                <a href="{% url 'course_detail' lesson.module.course.pk %}" class="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-300">
                    <span>Complete Course</span>
                    <i class="fas fa-trophy"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Lesson Content -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <!-- Lesson Content -->
                <div class="prose max-w-none">
                    {{ lesson.content|safe }}
                </div>

                <!-- Code Examples -->
                {% if lesson.code_examples.all %}
                <div class="mt-8">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Code Examples</h3>
                    <div class="space-y-6">
                        {% for code_example in lesson.code_examples.all %}
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-800 text-white px-4 py-2 flex justify-between items-center">
                                <span class="font-mono text-sm">{{ code_example.title }}</span>
                                <span class="px-2 py-1 bg-gray-700 rounded text-xs">{{ code_example.language }}</span>
                            </div>
                            <pre class="bg-gray-900 text-gray-100 p-4 overflow-x-auto"><code class="language-{{ code_example.language }}">{{ code_example.code }}</code></pre>
                            {% if code_example.explanation %}
                            <div class="bg-gray-50 p-4 border-t border-gray-200">
                                <div class="prose prose-sm max-w-none">
                                    {{ code_example.explanation|safe }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Video Embed -->
                {% if lesson.video_url %}
                <div class="mt-8">
                    <h3 class="text-2xl font-semibold text-gray-900 mb-4">Video Tutorial</h3>
                    <div class="aspect-w-16 aspect-h-9 bg-gray-200 rounded-lg overflow-hidden">
                        <!-- You can integrate with a video embedding solution here -->
                        <div class="flex items-center justify-center h-64 bg-gray-800 text-white">
                            <div class="text-center">
                                <i class="fas fa-video text-4xl mb-2"></i>
                                <p>Video: {{ lesson.video_url }}</p>
                                <a href="{{ lesson.video_url }}" target="_blank" class="inline-block mt-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                    Watch Video
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Lesson Sidebar -->
        <div class="space-y-6">
            <!-- Course Progress -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Course Progress</h3>
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center">
                        <div class="relative">
                            <svg class="w-20 h-20" viewBox="0 0 36 36">
                                <path d="M18 2.0845
                                    a 15.9155 15.9155 0 0 1 0 31.831
                                    a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none" stroke="#eee" stroke-width="3"/>
                                <path d="M18 2.0845
                                    a 15.9155 15.9155 0 0 1 0 31.831
                                    a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none" stroke="#10b981" stroke-width="3" 
                                    stroke-dasharray="{{ user_progress.progress_percentage }}, 100"/>
                            </svg>
                            <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-lg font-bold text-gray-700">
                                {{ user_progress.progress_percentage }}%
                            </span>
                        </div>
                    </div>
                </div>
                <p class="text-center text-sm text-gray-600">
                    {{ user_progress.get_completed_lessons_count }} of {{ user_progress.get_total_lessons_count }} lessons completed
                </p>
            </div>

            <!-- Lesson Navigation -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Module Lessons</h3>
                <div class="space-y-2">
                    {% for module_lesson in lesson.module.lessons.all %}
                    <a href="{% url 'lesson_detail' module_lesson.pk %}" 
                       class="flex items-center justify-between p-3 rounded-lg {% if module_lesson.id == lesson.id %}bg-indigo-50 border border-indigo-200{% else %}hover:bg-gray-50{% endif %}">
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs 
                                {% if module_lesson.id == lesson.id %}bg-indigo-600 text-white
                                {% elif module_lesson.id in completed_lessons %}bg-green-100 text-green-800
                                {% else %}bg-gray-100 text-gray-600{% endif %}">
                                {{ forloop.counter }}
                            </div>
                            <span class="text-sm {% if module_lesson.id == lesson.id %}font-semibold text-indigo-700{% else %}text-gray-700{% endif %}">
                                {{ module_lesson.title }}
                            </span>
                        </div>
                        {% if module_lesson.id in completed_lessons %}
                        <i class="fas fa-check text-green-500 text-sm"></i>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // AJAX lesson completion
    const completionForms = document.querySelectorAll('.lesson-completion-form');
    
    completionForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitButton = this.querySelector('button[type="submit"]');
            
            // Disable button during request
            submitButton.disabled = true;
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update button state
                    const isCompleted = data.is_completed;
                    if (isCompleted) {
                        submitButton.innerHTML = '<i class="fas fa-check-circle"></i><span>Completed</span>';
                        submitButton.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg bg-green-100 text-green-800 hover:bg-gray-200 transition duration-300';
                    } else {
                        submitButton.innerHTML = '<i class="fas fa-circle"></i><span>Mark Complete</span>';
                        submitButton.className = 'flex items-center space-x-2 px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-300';
                    }
                    
                    // Update progress bar if exists
                    const progressBar = document.querySelector('.bg-green-600');
                    if (progressBar) {
                        progressBar.style.width = data.progress_percentage + '%';
                    }
                    
                    // Update progress text
                    const progressText = document.querySelector('span:contains("%")');
                    if (progressText) {
                        progressText.textContent = data.progress_percentage + '%';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                submitButton.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}